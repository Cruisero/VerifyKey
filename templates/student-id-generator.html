<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student ID Card Generator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTML2Canvas for capturing DOM as image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF for generating PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- EXIF.js for adding metadata -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom styles for the ID card to ensure exact dimensions and professional look */
        .id-card-container {
            width: 3.5in;
            /* Standard landscape ID card width */
            height: 2.4in;
            /* Increased height to show all content */
            box-sizing: border-box;
            display: flex;
            flex-direction: row;
            background-color: white;
            position: relative;
            overflow: hidden;
        }

        .photo-section {
            width: 35%;
            height: 100%;
            flex-shrink: 0;
            background-color: #f3f4f6;
        }

        .photo-section img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .info-section {
            width: 65%;
            padding: 0.12in 0.15in;
            display: flex;
            flex-direction: column;
            background-color: white;
            overflow: hidden;
        }

        /* Hide the default file input text */
        input[type="file"] {
            color: transparent;
        }

        /* Style for the 3D "ghost" buttons */
        .modern-button {
            background-color: transparent;
            color: #4F46E5;
            padding: 0.6rem 1.2rem;
            border-radius: 9999px;
            cursor: pointer;
            display: inline-block;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.15s ease-out;
            border: 2px solid #4F46E5;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 4px #4338CA;
            position: relative;
            top: 0;
            user-select: none;
        }

        .modern-button:hover {
            background-color: #4F46E5;
            color: #fff;
            top: 2px;
            box-shadow: 0 2px #4338CA;
        }

        .modern-button:active {
            top: 4px;
            box-shadow: 0 0 #4338CA;
        }

        .modern-button.success {
            border-color: #10B981;
            color: #10B981;
            box-shadow: 0 4px #059669;
        }

        .modern-button.success:hover {
            background-color: #10B981;
            color: #fff;
        }

        /* Custom modal for messages */
        .custom-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            text-align: center;
            color: #333;
            display: none;
            min-width: 300px;
            font-weight: 600;
        }

        .custom-modal.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .custom-modal.success {
            border-left: 6px solid #28a745;
        }

        .custom-modal.error {
            border-left: 6px solid #dc3545;
        }

        .custom-modal.info {
            border-left: 6px solid #4F46E5;
        }

        /* Post-processing controls */
        .processing-controls {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1rem;
        }

        .processing-controls label {
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .processing-controls input[type="range"] {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .processing-controls input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="flex flex-col lg:flex-row bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-6xl">
        <!-- Left Panel: Edit Area -->
        <div class="w-full lg:w-1/2 p-6 md:p-8 space-y-4 border-r border-gray-200 overflow-y-auto"
            style="max-height: 90vh;">
            <div class="flex items-center justify-center mb-6">
                <h2 class="text-3xl font-extrabold text-gray-800 tracking-tight">ID Card Editor</h2>
            </div>

            <!-- Photo Generation Option -->
            <div class="border-b border-gray-100 pb-6 mb-2">
                <label class="block text-sm font-semibold text-gray-600 mb-2 uppercase tracking-wide">Student
                    Photo</label>
                <div class="flex flex-col gap-3">
                    <!-- Gender Selection -->
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="gender" value="any" checked class="w-4 h-4 text-indigo-600">
                            <span class="text-sm text-gray-600">Any</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="gender" value="male" class="w-4 h-4 text-indigo-600">
                            <span class="text-sm text-gray-600">Male</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="gender" value="female" class="w-4 h-4 text-indigo-600">
                            <span class="text-sm text-gray-600">Female</span>
                        </label>
                    </div>
                    <!-- Generate and Upload Buttons -->
                    <div class="flex items-center gap-3">
                        <button id="generatePhotoBtn"
                            class="modern-button flex-1 flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                </path>
                            </svg>
                            Generate Face
                        </button>
                        <label for="studentPhotoUpload" class="modern-button cursor-pointer">
                            Upload
                        </label>
                    </div>
                    <span id="fileName" class="text-sm text-gray-500 italic text-center">Click "Generate Face" for AI
                        photo</span>
                </div>
                <input type="file" id="studentPhotoUpload" accept="image/*" class="hidden">
            </div>

            <!-- Text Fields -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div class="md:col-span-2">
                    <label for="universityNameInput"
                        class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">University
                        Name</label>
                    <input type="text" id="universityNameInput" value="Guru Gobind Singh Indraprastha University"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all text-sm">
                </div>
                <div class="md:col-span-2">
                    <label for="nameInput"
                        class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Student Name</label>
                    <input type="text" id="nameInput" value="ANIL KUMAR"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all text-sm">
                </div>
                <div>
                    <label for="dobInput"
                        class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Date of Birth</label>
                    <input type="text" id="dobInput" value="March 10 2004"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all text-sm">
                </div>
                <div>
                    <label for="studentIdInput"
                        class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Student ID</label>
                    <input type="text" id="studentIdInput" value="9199-8219"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all text-sm">
                </div>
                <div>
                    <label for="phoneInput"
                        class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Phone</label>
                    <input type="text" id="phoneInput" value="+91 808270026"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all text-sm">
                </div>
                <div>
                    <label for="academicYearInput"
                        class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Academic Year</label>
                    <input type="text" id="academicYearInput" value="2025"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all text-sm">
                </div>
                <div class="md:col-span-2">
                    <label for="addressInput"
                        class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Address</label>
                    <input type="text" id="addressInput" value="3448, Hans Puri Ro Rampura"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all text-sm">
                </div>
            </div>

            <!-- Post-Processing Controls - NEW -->
            <div class="processing-controls">
                <h3 class="text-white font-bold text-sm mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
                        </path>
                    </svg>
                    Photo Realism Post-Processing
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label>Noise: <span id="noiseValue">8</span>%</label>
                        <input type="range" id="noiseLevel" min="0" max="25" value="8">
                    </div>
                    <div>
                        <label>Blur: <span id="blurValue">0.4</span>px</label>
                        <input type="range" id="blurLevel" min="0" max="15" value="4" step="1">
                    </div>
                    <div>
                        <label>Brightness: <span id="brightnessValue">96</span>%</label>
                        <input type="range" id="brightnessLevel" min="85" max="105" value="96">
                    </div>
                    <div>
                        <label>Contrast: <span id="contrastValue">97</span>%</label>
                        <input type="range" id="contrastLevel" min="85" max="110" value="97">
                    </div>
                    <div>
                        <label>JPEG Quality: <span id="qualityValue">85</span>%</label>
                        <input type="range" id="jpegQuality" min="60" max="95" value="85">
                    </div>
                    <div>
                        <label>Color Shift: <span id="hueValue">2</span>°</label>
                        <input type="range" id="hueShift" min="-10" max="10" value="2">
                    </div>
                </div>
                <div class="mt-3 flex items-center gap-2">
                    <input type="checkbox" id="enableProcessing" checked class="w-4 h-4 rounded">
                    <label for="enableProcessing" class="text-white text-xs">Enable Post-Processing
                        (Recommended)</label>
                </div>
            </div>
        </div>

        <!-- Right Panel: Live Card View -->
        <div
            class="w-full lg:w-1/2 p-6 md:p-8 flex flex-col items-center justify-center bg-gray-50 relative border-t lg:border-t-0 lg:border-l border-gray-200">
            <h2 class="text-2xl font-bold text-gray-400 mb-8 uppercase tracking-widest text-center">Live Preview</h2>

            <!-- ID Card Preview Area -->
            <div class="relative group">
                <div id="idCardPreview" class="id-card-container shadow-xl rounded overflow-hidden">
                    <!-- Photo Section -->
                    <div class="photo-section relative">
                        <img id="cardStudentPhoto" src="https://placehold.co/252x324/BFDBFE/374151?text=PHOTO"
                            alt="Student Photo"
                            onerror="this.onerror=null;this.src='https://placehold.co/252x324/BFDBFE/374151?text=PHOTO';">
                        <div class="absolute inset-0 ring-1 ring-inset ring-black/10"></div>
                    </div>
                    <!-- Info Section -->
                    <div class="info-section">
                        <div class="flex items-center gap-2 mb-1">
                            <div
                                class="w-8 h-8 flex items-center justify-center bg-indigo-600 rounded-full text-white shrink-0">
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path
                                        d="M12 2L1 7.5V13.75C1 18.31 4.21 22.5 12 24C19.79 22.5 23 18.31 23 13.75V7.5L12 2ZM12 4.3L19.92 8.5L12 12.7L4.08 8.5L12 4.3ZM5 14.5C5 15.8 5.75 16.95 7 17.65V15.5H9V19.5C6.2 18.88 5 16.81 5 14.5Z M15 19.5V15.5H17V17.65C18.25 16.95 19 15.8 19 14.5C19 12.19 15.8 10.12 12 10.12C8.2 10.12 5 12.19 5 14.5H3C3 11.12 7.5 8.5 12 8.5C16.5 8.5 21 11.12 21 14.5C21 17.5 17.8 20.1 15 20.8V19.5Z" />
                                </svg>
                            </div>
                            <p id="cardUniversityName"
                                class="font-bold text-gray-800 text-[9px] leading-tight uppercase"></p>
                        </div>

                        <p
                            class="text-[10px] font-bold text-indigo-500 mt-2 tracking-widest uppercase border-b border-indigo-100 pb-1 mb-1">
                            Student ID Card</p>
                        <p id="cardName"
                            class="text-[14px] font-extrabold text-gray-900 leading-tight uppercase truncate shrink-0">
                        </p>

                        <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-[7px] flex-grow mt-2">
                            <div>
                                <p class="text-gray-400 font-bold tracking-wider uppercase">Date of Birth</p>
                                <p id="cardDob" class="text-gray-800 font-semibold truncate"></p>
                            </div>
                            <div>
                                <p class="text-gray-400 font-bold tracking-wider uppercase">Student ID</p>
                                <p id="cardStudentId" class="text-gray-800 font-semibold truncate"></p>
                            </div>
                            <div>
                                <p class="text-gray-400 font-bold tracking-wider uppercase">Phone</p>
                                <p id="cardPhone" class="text-gray-800 font-semibold truncate"></p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-gray-400 font-bold tracking-wider uppercase">Address</p>
                                <p id="cardAddress" class="text-gray-800 font-semibold leading-tight line-clamp-2"></p>
                            </div>
                        </div>

                        <div class="text-[7px] mt-auto pt-2 border-t border-gray-100 flex justify-between items-end">
                            <div>
                                <p class="text-gray-400 font-bold tracking-wider uppercase">Valid Thru</p>
                                <p id="cardAcademicYear" class="text-gray-800 font-semibold"></p>
                            </div>
                            <div class="w-8 h-8 opacity-20">
                                <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"
                                    class="w-full h-full text-black fill-current">
                                    <path
                                        d="M0 0H35V35H0V0ZM5 5V30H30V5H5ZM65 0H100V35H65V0ZM70 5V30H95V5H70ZM0 65H35V100H0V65ZM5 70V95H30V70H5ZM40 40H60V60H40V40ZM65 65H80V80H65V65ZM85 85H100V100H85V85Z" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Download Buttons -->
            <div class="flex gap-4 mt-10">
                <button id="downloadCardButton" class="modern-button flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                            clip-rule="evenodd" />
                    </svg>
                    Download PNG
                </button>
                <button id="downloadJpegButton" class="modern-button success flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"
                            clip-rule="evenodd" />
                    </svg>
                    Download JPEG (Recommended)
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-4 text-center">JPEG with post-processing for realistic camera look</p>
        </div>
    </div>

    <script>
        // ============================================
        // POST-PROCESSING FUNCTIONS (NEW)
        // ============================================

        // Add realistic camera noise to image
        function addNoise(ctx, width, height, intensity) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                // Gaussian-like noise
                const noise = (Math.random() + Math.random() + Math.random() - 1.5) * intensity;
                data[i] = Math.max(0, Math.min(255, data[i] + noise));       // R
                data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + noise)); // G
                data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + noise)); // B
            }

            ctx.putImageData(imageData, 0, 0);
        }

        // Adjust brightness and contrast
        function adjustBrightnessContrast(ctx, width, height, brightness, contrast) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;

            const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));

            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.max(0, Math.min(255, factor * (data[i] - 128) + 128 + brightness));
                data[i + 1] = Math.max(0, Math.min(255, factor * (data[i + 1] - 128) + 128 + brightness));
                data[i + 2] = Math.max(0, Math.min(255, factor * (data[i + 2] - 128) + 128 + brightness));
            }

            ctx.putImageData(imageData, 0, 0);
        }

        // Apply slight color/hue shift (simulates camera white balance)
        function applyHueShift(ctx, width, height, degrees) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;

            const angle = degrees * Math.PI / 180;
            const cosA = Math.cos(angle);
            const sinA = Math.sin(angle);

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];

                // Simple RGB rotation for hue shift
                data[i] = Math.max(0, Math.min(255, r * cosA + g * sinA * 0.3));
                data[i + 1] = Math.max(0, Math.min(255, g * cosA + b * sinA * 0.3));
                data[i + 2] = Math.max(0, Math.min(255, b * cosA + r * sinA * 0.3));
            }

            ctx.putImageData(imageData, 0, 0);
        }

        // Apply slight vignette effect (darker corners)
        function applyVignette(ctx, width, height, intensity = 0.3) {
            const centerX = width / 2;
            const centerY = height / 2;
            const maxDist = Math.sqrt(centerX * centerX + centerY * centerY);

            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const i = (y * width + x) * 4;
                    const dist = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);
                    const factor = 1 - (dist / maxDist) * intensity;

                    data[i] *= factor;
                    data[i + 1] *= factor;
                    data[i + 2] *= factor;
                }
            }

            ctx.putImageData(imageData, 0, 0);
        }

        // Apply box blur (simple blur algorithm)
        function applyBlur(ctx, width, height, radius) {
            if (radius < 0.5) return;

            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            const copy = new Uint8ClampedArray(data);

            const size = Math.ceil(radius);
            const kernel = (size * 2 + 1) ** 2;

            for (let y = size; y < height - size; y++) {
                for (let x = size; x < width - size; x++) {
                    let r = 0, g = 0, b = 0;

                    for (let ky = -size; ky <= size; ky++) {
                        for (let kx = -size; kx <= size; kx++) {
                            const i = ((y + ky) * width + (x + kx)) * 4;
                            r += copy[i];
                            g += copy[i + 1];
                            b += copy[i + 2];
                        }
                    }

                    const i = (y * width + x) * 4;
                    data[i] = r / kernel;
                    data[i + 1] = g / kernel;
                    data[i + 2] = b / kernel;
                }
            }

            ctx.putImageData(imageData, 0, 0);
        }

        // Main post-processing pipeline
        async function applyPostProcessing(canvas) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Get settings from UI
            const noiseLevel = parseInt(document.getElementById('noiseLevel').value);
            const blurLevel = parseFloat(document.getElementById('blurLevel').value) / 10;
            const brightnessLevel = (parseInt(document.getElementById('brightnessLevel').value) - 100) * 2;
            const contrastLevel = (parseInt(document.getElementById('contrastLevel').value) - 100) * 2;
            const hueShift = parseInt(document.getElementById('hueShift').value);

            // Apply effects in order
            if (blurLevel > 0) {
                applyBlur(ctx, width, height, blurLevel);
            }

            if (noiseLevel > 0) {
                addNoise(ctx, width, height, noiseLevel);
            }

            if (brightnessLevel !== 0 || contrastLevel !== 0) {
                adjustBrightnessContrast(ctx, width, height, brightnessLevel, contrastLevel);
            }

            if (hueShift !== 0) {
                applyHueShift(ctx, width, height, hueShift);
            }

            // Slight vignette for realistic camera look
            applyVignette(ctx, width, height, 0.15);

            return canvas;
        }

        // Generate fake EXIF metadata (embedded in filename for now)
        function generateFakeMetadata() {
            const phones = [
                { make: 'Apple', model: 'iPhone 13' },
                { make: 'Apple', model: 'iPhone 12' },
                { make: 'Samsung', model: 'Galaxy S21' },
                { make: 'Google', model: 'Pixel 6' },
                { make: 'OnePlus', model: '9 Pro' }
            ];

            const phone = phones[Math.floor(Math.random() * phones.length)];
            const date = new Date();
            date.setDate(date.getDate() - Math.floor(Math.random() * 30)); // Random date within last 30 days

            return {
                phone,
                date: date.toISOString().split('T')[0].replace(/-/g, ''),
                time: date.toTimeString().split(' ')[0].replace(/:/g, '')
            };
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================

        function showMessage(message, type = 'info') {
            const existingModal = document.querySelector('.custom-modal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.className = `custom-modal ${type}`;
            modal.textContent = message;
            document.body.appendChild(modal);

            void modal.offsetWidth;

            modal.classList.add('show');
            setTimeout(() => {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
            }, 3000);
        }

        function handleImageUpload(event, targetElementId) {
            const file = event.target.files[0];
            const fileNameSpan = document.getElementById('fileName');

            if (file) {
                if (file.size > 2 * 1024 * 1024) {
                    showMessage("Image is too large. Please use an image under 2MB.", "error");
                    return;
                }

                fileNameSpan.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById(targetElementId).src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                fileNameSpan.textContent = "No file chosen";
            }
        }

        function updateCardField(inputId, cardElementId) {
            const inputElement = document.getElementById(inputId);
            const cardElement = document.getElementById(cardElementId);

            const update = () => cardElement.textContent = inputElement.value;

            update();
            inputElement.addEventListener('input', update);
        }

        // Update slider value displays
        function setupSliderDisplays() {
            const sliders = [
                { id: 'noiseLevel', display: 'noiseValue', suffix: '' },
                { id: 'blurLevel', display: 'blurValue', suffix: '', divisor: 10 },
                { id: 'brightnessLevel', display: 'brightnessValue', suffix: '' },
                { id: 'contrastLevel', display: 'contrastValue', suffix: '' },
                { id: 'jpegQuality', display: 'qualityValue', suffix: '' },
                { id: 'hueShift', display: 'hueValue', suffix: '' }
            ];

            sliders.forEach(({ id, display, divisor }) => {
                const slider = document.getElementById(id);
                const displayEl = document.getElementById(display);

                slider.addEventListener('input', () => {
                    displayEl.textContent = divisor ? (slider.value / divisor).toFixed(1) : slider.value;
                });
            });
        }

        // ============================================
        // FACE GENERATION FUNCTIONS
        // ============================================

        // AI Face generation sources (multiple fallbacks)
        const FACE_SOURCES = [
            // Primary: thispersondoesnotexist (high quality GAN faces)
            {
                name: 'ThisPersonDoesNotExist',
                url: 'https://thispersondoesnotexist.com',
                cors: false  // Needs proxy
            },
            // Fallback 1: Generated Photos API (different faces each time)
            {
                name: 'Generated.Photos',
                getUrl: (gender) => {
                    const g = gender === 'any' ? '' : `&gender=${gender}`;
                    return `https://api.generated.photos/api/v1/faces?per_page=1&order_by=random${g}`;
                },
                cors: true,
                needsKey: true
            },
            // Fallback 2: UI Faces (stock photos - less ideal but reliable)
            {
                name: 'UI Faces',
                getUrl: (gender) => {
                    const g = gender === 'any' ? '' : `&gender[]=${gender}`;
                    return `https://uifaces.co/api?limit=1${g}`;
                },
                cors: true
            },
            // Fallback 3: RandomUser.me (real stock photos)
            {
                name: 'RandomUser',
                getUrl: (gender) => {
                    const g = gender === 'any' ? '' : `&gender=${gender}`;
                    return `https://randomuser.me/api/?inc=picture&nat=us${g}`;
                },
                cors: true,
                parseResponse: (data) => data.results[0].picture.large
            }
        ];

        // Cached faces to avoid repeated API calls
        let cachedFaces = [];

        async function generateFace() {
            const btn = document.getElementById('generatePhotoBtn');
            const fileNameSpan = document.getElementById('fileName');
            const photoImg = document.getElementById('cardStudentPhoto');
            const gender = document.querySelector('input[name="gender"]:checked').value;

            // Update UI
            btn.disabled = true;
            btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...';
            fileNameSpan.textContent = 'Fetching AI-generated face...';

            try {
                // Try RandomUser.me first (most reliable, real photos)
                const response = await fetch(`https://randomuser.me/api/?inc=picture&nat=us,gb,au,ca${gender === 'any' ? '' : '&gender=' + gender}`);

                if (response.ok) {
                    const data = await response.json();
                    const imageUrl = data.results[0].picture.large;

                    // Fetch the actual image to convert to base64 (for CORS)
                    const imgResponse = await fetch(imageUrl);
                    const blob = await imgResponse.blob();

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        photoImg.src = e.target.result;
                        fileNameSpan.textContent = '✅ AI face generated successfully!';
                        showMessage('Face generated! You can click again for a different face.', 'success');
                    };
                    reader.readAsDataURL(blob);
                } else {
                    throw new Error('RandomUser API failed');
                }
            } catch (error) {
                console.error('Face generation error:', error);

                // Fallback: Use a set of pre-defined realistic placeholder faces
                const fallbackFaces = [
                    'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=300&h=400&fit=crop&crop=face',
                    'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=300&h=400&fit=crop&crop=face',
                    'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=300&h=400&fit=crop&crop=face',
                    'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=300&h=400&fit=crop&crop=face',
                    'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=300&h=400&fit=crop&crop=face',
                    'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=300&h=400&fit=crop&crop=face'
                ];

                const randomFace = fallbackFaces[Math.floor(Math.random() * fallbackFaces.length)];

                try {
                    const imgResponse = await fetch(randomFace);
                    const blob = await imgResponse.blob();

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        photoImg.src = e.target.result;
                        fileNameSpan.textContent = '✅ Face loaded (fallback source)';
                        showMessage('Face loaded from fallback source.', 'info');
                    };
                    reader.readAsDataURL(blob);
                } catch (fallbackError) {
                    fileNameSpan.textContent = '❌ Failed to generate face. Please upload manually.';
                    showMessage('Could not generate face. Please upload a photo manually.', 'error');
                }
            } finally {
                // Restore button
                btn.disabled = false;
                btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> Generate Face';
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            // Image upload listener
            document.getElementById('studentPhotoUpload').addEventListener('change', (e) => handleImageUpload(e, 'cardStudentPhoto'));

            // Generate face button listener
            document.getElementById('generatePhotoBtn').addEventListener('click', generateFace);

            // Text field listeners
            updateCardField('universityNameInput', 'cardUniversityName');
            updateCardField('nameInput', 'cardName');
            updateCardField('dobInput', 'cardDob');
            updateCardField('studentIdInput', 'cardStudentId');
            updateCardField('phoneInput', 'cardPhone');
            updateCardField('addressInput', 'cardAddress');
            updateCardField('academicYearInput', 'cardAcademicYear');

            // Setup slider displays
            setupSliderDisplays();

            // Auto-generate a face on load (optional - uncomment to enable)
            // setTimeout(generateFace, 500);
        });

        // ============================================
        // DOWNLOAD FUNCTIONS
        // ============================================

        async function captureCard(format = 'png') {
            const card = document.getElementById('idCardPreview');
            const scaleFactor = 4;
            const enableProcessing = document.getElementById('enableProcessing').checked;
            const jpegQuality = parseInt(document.getElementById('jpegQuality').value) / 100;

            showMessage("Generating your card with realistic effects...", "info");

            await new Promise(resolve => setTimeout(resolve, 100));

            let canvas = await html2canvas(card, {
                scale: scaleFactor,
                useCORS: true,
                logging: false,
                backgroundColor: null,
                width: card.offsetWidth,
                height: card.offsetHeight
            });

            // Apply post-processing if enabled
            if (enableProcessing) {
                canvas = await applyPostProcessing(canvas);
            }

            const studentName = document.getElementById('nameInput').value.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'student';
            const metadata = generateFakeMetadata();

            // Generate filename with fake camera metadata
            const filename = `IMG_${metadata.date}_${metadata.time}_${studentName}`;

            if (format === 'jpeg') {
                // JPEG with quality control
                const jpegUrl = canvas.toDataURL('image/jpeg', jpegQuality);
                const link = document.createElement('a');
                link.href = jpegUrl;
                link.download = `${filename}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                // PNG
                const pngUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = pngUrl;
                link.download = `${filename}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            showMessage(`Success! ${format.toUpperCase()} downloaded with realistic camera effects.`, "success");
        }

        // Download PNG
        document.getElementById('downloadCardButton').addEventListener('click', async () => {
            const btn = document.getElementById('downloadCardButton');
            btn.style.pointerEvents = 'none';
            btn.style.opacity = '0.7';

            try {
                await captureCard('png');
            } catch (error) {
                console.error("Error generating card:", error);
                showMessage("Failed to generate card. Please try again.", "error");
            } finally {
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
            }
        });

        // Download JPEG (Recommended)
        document.getElementById('downloadJpegButton').addEventListener('click', async () => {
            const btn = document.getElementById('downloadJpegButton');
            btn.style.pointerEvents = 'none';
            btn.style.opacity = '0.7';

            try {
                await captureCard('jpeg');
            } catch (error) {
                console.error("Error generating card:", error);
                showMessage("Failed to generate card. Please try again.", "error");
            } finally {
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
            }
        });
    </script>
</body>

</html>